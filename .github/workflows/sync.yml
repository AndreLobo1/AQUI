name: SincronizaÃ§Ã£o Financeira AutomÃ¡tica

on:
  # ExecuÃ§Ã£o agendada diÃ¡ria Ã s 8h UTC
  schedule:
    - cron: '0 8 * * *'
  
  # ExecuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'ForÃ§ar sincronizaÃ§Ã£o completa'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-financial-data:
    name: Sincronizar Dados Financeiros
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
        
      - name: Criar arquivo .env
        run: |
          echo "${{ secrets.DOT_ENV_FILE }}" > .env
          echo "âœ… Arquivo .env criado"
          
      - name: Extrair nome do arquivo JSON do .env
        id: extract_json_name
        run: |
          # Extrair GOOGLE_CREDENTIALS_FILE do .env
          JSON_FILE=$(grep '^GOOGLE_CREDENTIALS_FILE=' .env | cut -d'=' -f2)
          echo "json_file=$JSON_FILE" >> $GITHUB_OUTPUT
          echo "ğŸ“„ Nome do arquivo JSON: $JSON_FILE"
          
      - name: Criar arquivo de credenciais JSON
        run: |
          echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" > ${{ steps.extract_json_name.outputs.json_file }}
          echo "âœ… Arquivo de credenciais criado: ${{ steps.extract_json_name.outputs.json_file }}"
          
      - name: Verificar arquivos criados
        run: |
          echo "ğŸ“ ConteÃºdo da pasta:"
          ls -la
          echo ""
          echo "ğŸ“„ ConteÃºdo do .env (sem credenciais):"
          cat .env | grep -v PASSWORD
          echo ""
          echo "ğŸ”‘ Arquivo JSON existe:"
          ls -la ${{ steps.extract_json_name.outputs.json_file }}
          
      - name: Executar sincronizaÃ§Ã£o
        run: |
          echo "ğŸš€ Iniciando sincronizaÃ§Ã£o..."
          if [ "${{ inputs.force_sync }}" = "true" ]; then
            echo "ğŸ”„ ForÃ§ando sincronizaÃ§Ã£o completa..."
            docker-compose build --no-cache
          fi
          docker-compose run --rm carteira
          echo "âœ… SincronizaÃ§Ã£o concluÃ­da"
          
      - name: Limpar arquivos sensÃ­veis
        if: always()
        run: |
          echo "ğŸ§¹ Limpando arquivos sensÃ­veis..."
          rm -f .env
          rm -f ${{ steps.extract_json_name.outputs.json_file }}
          echo "âœ… Limpeza concluÃ­da"
          
      - name: Notificar sucesso
        if: success()
        run: |
          echo "ğŸ‰ SincronizaÃ§Ã£o executada com sucesso!"
          echo "ğŸ“Š Dados atualizados no Google Sheets"
          
      - name: Notificar falha
        if: failure()
        run: |
          echo "âŒ SincronizaÃ§Ã£o falhou!"
          echo "ğŸ” Verifique os logs acima para mais detalhes"
